/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var I=Object.defineProperty;var A=Object.getOwnPropertyDescriptor;var T=Object.getOwnPropertyNames;var R=Object.prototype.hasOwnProperty;var M=(h,s)=>{for(var t in s)I(h,t,{get:s[t],enumerable:!0})},N=(h,s,t,e)=>{if(s&&typeof s=="object"||typeof s=="function")for(let i of T(s))!R.call(h,i)&&i!==t&&I(h,i,{get:()=>s[i],enumerable:!(e=A(s,i))||e.enumerable});return h};var W=h=>N(I({},"__esModule",{value:!0}),h);var U={};M(U,{default:()=>D});module.exports=W(U);var o=require("obsidian");var x=class{constructor(s){this.settings=s;this.ws=null;this.reconnectAttempts=0;this.maxReconnectAttempts=5;this.reconnectDelay=1e3;this.messageHandlers=new Map;this.baseUrl=`http://${s.apiUrl}:${s.apiPort}`,this.wsUrl=`ws://${s.apiUrl}:8766`}async connect(){await this.testConnection(),this.settings.enableWebSocket&&await this.connectWebSocket()}async disconnect(){this.ws&&(this.ws.close(),this.ws=null)}async testConnection(){try{let s=await fetch(`${this.baseUrl}/health`);if(!s.ok)throw new Error(`HTTP ${s.status}: ${s.statusText}`);if((await s.json()).status!=="ok")throw new Error("API\u670D\u52A1\u5668\u72B6\u6001\u5F02\u5E38");console.log("OpenClaw API\u8FDE\u63A5\u6D4B\u8BD5\u6210\u529F")}catch(s){throw console.error("OpenClaw API\u8FDE\u63A5\u6D4B\u8BD5\u5931\u8D25:",s),new Error(`\u8FDE\u63A5\u6D4B\u8BD5\u5931\u8D25: ${s.message}`)}}async getMemoryInfo(){return await(await this.fetchWithRetry(`${this.baseUrl}/api/memory/info`)).json()}async getFiles(){return(await(await this.fetchWithRetry(`${this.baseUrl}/api/memory/files`)).json()).files.map(e=>({...e,created:new Date(e.created),modified:new Date(e.modified)}))}async getFile(s){let e=await(await this.fetchWithRetry(`${this.baseUrl}/api/memory/files/${s}`)).json();return{...e,stats:{...e.stats,created:new Date(e.stats.created),modified:new Date(e.stats.modified)}}}async saveFile(s,t){let e=await fetch(`${this.baseUrl}/api/memory/files/${s}`,{method:"POST",headers:{"Content-Type":"text/plain"},body:t});if(!e.ok)throw new Error(`\u4FDD\u5B58\u6587\u4EF6\u5931\u8D25: ${e.statusText}`)}async deleteFile(s){let t=await fetch(`${this.baseUrl}/api/memory/files/${s}`,{method:"DELETE"});if(!t.ok)throw new Error(`\u5220\u9664\u6587\u4EF6\u5931\u8D25: ${t.statusText}`)}async search(s){return(await(await this.fetchWithRetry(`${this.baseUrl}/api/memory/search?q=${encodeURIComponent(s)}`)).json()).results}async getStats(){let t=await(await this.fetchWithRetry(`${this.baseUrl}/api/memory/stats`)).json();return{...t,lastUpdated:new Date(t.lastUpdated)}}async fetchWithRetry(s,t={},e=3){for(let i=0;i<e;i++)try{let n=await fetch(s,t);if(n.ok)return n;i<e-1&&await this.sleep(1e3*(i+1))}catch(n){if(i<e-1)await this.sleep(1e3*(i+1));else throw n}throw new Error(`\u8BF7\u6C42\u5931\u8D25: ${s}`)}sleep(s){return new Promise(t=>setTimeout(t,s))}async connectWebSocket(){return new Promise((s,t)=>{try{this.ws=new WebSocket(this.wsUrl),this.ws.onopen=()=>{var e;console.log("OpenClaw WebSocket\u8FDE\u63A5\u6210\u529F"),this.reconnectAttempts=0,(e=this.ws)==null||e.send(JSON.stringify({type:"subscribe",channels:["file_changes"]})),s()},this.ws.onmessage=e=>{try{let i=JSON.parse(e.data);this.handleWebSocketMessage(i)}catch(i){console.error("WebSocket\u6D88\u606F\u89E3\u6790\u5931\u8D25:",i)}},this.ws.onclose=()=>{if(console.log("OpenClaw WebSocket\u8FDE\u63A5\u5173\u95ED"),this.ws=null,this.reconnectAttempts<this.maxReconnectAttempts){this.reconnectAttempts++;let e=this.reconnectDelay*Math.pow(2,this.reconnectAttempts-1);console.log(`WebSocket\u5C06\u5728 ${e}ms \u540E\u91CD\u8FDE (\u5C1D\u8BD5 ${this.reconnectAttempts}/${this.maxReconnectAttempts})`),setTimeout(()=>{this.connectWebSocket().catch(console.error)},e)}},this.ws.onerror=e=>{console.error("OpenClaw WebSocket\u9519\u8BEF:",e),t(e)}}catch(e){t(e)}})}handleWebSocketMessage(s){var t;switch(s.type){case"welcome":console.log("WebSocket\u6B22\u8FCE\u6D88\u606F:",((t=s.data)==null?void 0:t.message)||"Connected");break;case"notification":this.emit(s.event||"unknown",s.data);break;case"pong":break;default:console.log("\u672A\u77E5\u7684WebSocket\u6D88\u606F\u7C7B\u578B:",s.type)}}on(s,t){var e;this.messageHandlers.has(s)||this.messageHandlers.set(s,[]),(e=this.messageHandlers.get(s))==null||e.push(t)}off(s,t){let e=this.messageHandlers.get(s);if(e){let i=e.indexOf(t);i>-1&&e.splice(i,1)}}emit(s,t){let e=this.messageHandlers.get(s);e&&e.forEach(i=>{try{i(t)}catch(n){console.error(`\u4E8B\u4EF6\u5904\u7406\u5668\u9519\u8BEF (${s}):`,n)}})}isConnected(){return this.ws!==null&&this.ws.readyState===WebSocket.OPEN}getConnectionStatus(){if(!this.ws)return"disconnected";switch(this.ws.readyState){case WebSocket.CONNECTING:return"connecting";case WebSocket.OPEN:return"connected";case WebSocket.CLOSING:return"closing";case WebSocket.CLOSED:return"closed";default:return"unknown"}}};var u=require("obsidian");var P=class{constructor(s,t,e){this.app=s;this.apiClient=t;this.settings=e;this.status={state:"idle",progress:0,currentFile:"",filesSynced:0,totalFiles:0,lastSync:null,errors:[]};this.statusChangeHandlers=[];this.isPaused=!1;this.syncQueue=[];this.fileCache=new Map;this.settings.enableWebSocket&&this.apiClient.on("file_changed",i=>{this.handleRemoteChange(i)})}async sync(){if(this.status.state==="syncing")throw new Error("\u540C\u6B65\u6B63\u5728\u8FDB\u884C\u4E2D");if(this.isPaused)throw new Error("\u540C\u6B65\u5DF2\u6682\u505C");try{this.updateStatus({state:"syncing",progress:0,currentFile:"\u6B63\u5728\u51C6\u5907\u540C\u6B65...",filesSynced:0,totalFiles:0,errors:[]});let s=await this.apiClient.getFiles(),t=await this.getLocalFiles(),e=this.calculateDiff(s,t);await this.applyDiff(e),this.updateStatus({state:"idle",progress:100,currentFile:"",filesSynced:e.added.length+e.modified.length+e.deleted.length,totalFiles:s.length+t.length,lastSync:new Date,errors:[]})}catch(s){throw this.updateStatus({state:"error",errors:[{message:s.message,timestamp:new Date,retryable:!0}]}),s}}async getLocalFiles(){let s=this.settings.targetFolder,t=this.app.vault.getAbstractFileByPath(s);if(!t||!(t instanceof u.TFolder))return[];let e=[],i=n=>{for(let a of n.children)if(a instanceof u.TFile&&a.extension==="md"){if(this.isExcluded(a.path))continue;e.push({name:a.name,path:a.path,size:a.stat.size,created:new Date(a.stat.ctime),modified:new Date(a.stat.mtime),lines:this.app.vault.read(a).then(r=>r.split(`
`).length).catch(()=>0),preview:""})}else a instanceof u.TFolder&&i(a)};i(t);for(let n of e)n.lines=await n.lines;return e}calculateDiff(s,t){let e={added:[],modified:[],deleted:[],conflicts:[]},i=new Map(s.map(a=>[a.name,a])),n=new Map(t.map(a=>[a.name,a]));for(let[a,r]of i)n.has(a)||e.added.push(a);for(let[a,r]of n)i.has(a)||(this.settings.conflictStrategy==="local"?e.added.push(a):e.deleted.push(a));for(let[a,r]of i){let p=n.get(a);if(p){let c=r.modified.getTime(),g=p.modified.getTime();if(Math.abs(c-g)>1e3){e.modified.push(a);let l=this.fileCache.get(a);l&&Math.abs(l.modified.getTime()-c)>1e3&&Math.abs(l.modified.getTime()-g)>1e3&&e.conflicts.push(a)}}}return e}async applyDiff(s){let t=s.added.length+s.modified.length+s.deleted.length,e=0;for(let i of s.added){this.updateStatus({currentFile:`\u6B63\u5728\u4E0B\u8F7D: ${i}`,progress:e/t*100});try{let n=await this.apiClient.getFile(i);await this.saveLocalFile(i,n.content),e++}catch(n){this.addError(`\u4E0B\u8F7D\u6587\u4EF6\u5931\u8D25: ${i}`,n,!0)}}for(let i of s.modified){this.updateStatus({currentFile:`\u6B63\u5728\u540C\u6B65: ${i}`,progress:e/t*100});try{if(s.conflicts.includes(i))await this.resolveConflict(i);else{let n=await this.apiClient.getFile(i);await this.saveLocalFile(i,n.content)}e++}catch(n){this.addError(`\u540C\u6B65\u6587\u4EF6\u5931\u8D25: ${i}`,n,!0)}}for(let i of s.deleted){this.updateStatus({currentFile:`\u6B63\u5728\u5220\u9664: ${i}`,progress:e/t*100});try{await this.deleteLocalFile(i),e++}catch(n){this.addError(`\u5220\u9664\u6587\u4EF6\u5931\u8D25: ${i}`,n,!1)}}}async resolveConflict(s){switch(this.settings.conflictStrategy){case"timestamp":await this.resolveByTimestamp(s);break;case"local":await this.uploadLocalFile(s);break;case"remote":await this.downloadRemoteFile(s);break;case"ask":await this.resolveByTimestamp(s);break}}async resolveByTimestamp(s){try{let t=await this.apiClient.getFile(s),e=this.getLocalPath(s),i=this.app.vault.getAbstractFileByPath(e);if(i instanceof u.TFile){let n=t.stats.modified.getTime(),a=i.stat.mtime;if(n>a)await this.saveLocalFile(s,t.content);else{let r=await this.app.vault.read(i);await this.apiClient.saveFile(s,r)}}}catch(t){throw new Error(`\u51B2\u7A81\u89E3\u51B3\u5931\u8D25: ${t.message}`)}}async downloadRemoteFile(s){let t=await this.apiClient.getFile(s);await this.saveLocalFile(s,t.content)}async uploadLocalFile(s){let t=this.getLocalPath(s),e=this.app.vault.getAbstractFileByPath(t);if(e instanceof u.TFile){let i=await this.app.vault.read(e);await this.apiClient.saveFile(s,i)}}async saveLocalFile(s,t){let e=this.getLocalPath(s),i=(0,u.normalizePath)(e),n=i.split("/").slice(0,-1).join("/");n&&await this.app.vault.createFolder(n).catch(()=>{});let a=this.app.vault.getAbstractFileByPath(i);a instanceof u.TFile?await this.app.vault.modify(a,t):await this.app.vault.create(i,t),this.fileCache.set(s,{content:t,modified:new Date})}async deleteLocalFile(s){let t=this.getLocalPath(s),e=this.app.vault.getAbstractFileByPath(t);e instanceof u.TFile&&await this.app.vault.delete(e),this.fileCache.delete(s)}getLocalPath(s){return(0,u.normalizePath)(`${this.settings.targetFolder}/${s}`)}isExcluded(s){for(let t of this.settings.excludePatterns)if(t.startsWith("*.")){let e=t.substring(1);if(s.endsWith(e))return!0}else if(t.startsWith(".")){if(s.split("/").some(i=>i.startsWith(".")))return!0}else if(t.endsWith("/")){if(s.includes(t))return!0}else if(s===t)return!0;return!1}async handleRemoteChange(s){if(this.status.state!=="idle"||this.isPaused)return;let{event:t,filename:e}=s;try{switch(t){case"added":case"changed":let i=await this.apiClient.getFile(e);await this.saveLocalFile(e,i.content);break;case"deleted":await this.deleteLocalFile(e);break}}catch(i){console.error(`\u5904\u7406\u8FDC\u7A0B\u53D8\u66F4\u5931\u8D25 (${t}: ${e}):`,i)}}updateStatus(s){this.status={...this.status,...s},this.notifyStatusChange()}addError(s,t,e){this.status.errors.push({message:`${s}: ${t.message}`,timestamp:new Date,retryable:e}),this.notifyStatusChange()}notifyStatusChange(){this.statusChangeHandlers.forEach(s=>{try{s({...this.status})}catch(t){console.error("\u72B6\u6001\u53D8\u66F4\u5904\u7406\u5668\u9519\u8BEF:",t)}})}getStatus(){return{...this.status}}onStatusChange(s){this.statusChangeHandlers.push(s)}offStatusChange(s){let t=this.statusChangeHandlers.indexOf(s);t>-1&&this.statusChangeHandlers.splice(t,1)}pause(){this.isPaused=!0,this.status.state==="syncing"&&this.updateStatus({state:"paused"})}resume(){this.isPaused=!1,this.status.state==="paused"&&this.updateStatus({state:"idle"})}isPausedState(){return this.isPaused}cleanup(){this.statusChangeHandlers=[],this.fileCache.clear(),this.syncQueue=[]}};var f=require("obsidian"),b="openclaw-memory-view",S=class extends f.ItemView{constructor(t,e){super(t);this.files=[];this.filteredFiles=[];this.searchQuery="";this.sortBy="modified";this.sortOrder="desc";this.isLoading=!1;this.lastRefresh=null;this.apiClient=e}getViewType(){return b}getDisplayText(){return"OpenClaw\u8BB0\u5FC6\u5E93"}getIcon(){return"brain"}async onOpen(){let t=this.containerEl.children[1];t.empty();let e=t.createDiv({cls:"openclaw-memory-view"});e.createDiv({cls:"openclaw-memory-header"}).createEl("h2",{text:"OpenClaw\u8BB0\u5FC6\u5E93"});let n=e.createDiv({cls:"openclaw-memory-controls"});n.createDiv({cls:"search-container"}).createEl("input",{type:"text",placeholder:"\u641C\u7D22\u8BB0\u5FC6\u6587\u4EF6...",cls:"search-input"}).addEventListener("input",m=>{this.searchQuery=m.target.value,this.filterAndSortFiles(),this.renderFileList()});let p=n.createDiv({cls:"sort-container"}),c=p.createEl("select",{cls:"sort-select"});c.createEl("option",{value:"name",text:"\u6309\u540D\u79F0"}),c.createEl("option",{value:"size",text:"\u6309\u5927\u5C0F"}),c.createEl("option",{value:"modified",text:"\u6309\u4FEE\u6539\u65F6\u95F4"}),c.createEl("option",{value:"created",text:"\u6309\u521B\u5EFA\u65F6\u95F4"}),c.value=this.sortBy,c.addEventListener("change",m=>{this.sortBy=m.target.value,this.filterAndSortFiles(),this.renderFileList()});let g=p.createEl("button",{text:this.sortOrder==="desc"?"\u2193":"\u2191",cls:"sort-order-button"});g.addEventListener("click",()=>{this.sortOrder=this.sortOrder==="desc"?"asc":"desc",g.setText(this.sortOrder==="desc"?"\u2193":"\u2191"),this.filterAndSortFiles(),this.renderFileList()}),n.createEl("button",{text:"\u5237\u65B0",cls:"refresh-button"}).addEventListener("click",()=>{this.refreshFiles()});let L=e.createDiv({cls:"file-list-container"});this.contentEl=L;let d=e.createDiv({cls:"status-bar"});this.statusEl=d,await this.refreshFiles()}async onClose(){}async refreshFiles(){this.isLoading=!0,this.updateStatus("\u6B63\u5728\u52A0\u8F7D\u6587\u4EF6...");try{this.files=await this.apiClient.getFiles(),this.lastRefresh=new Date,this.filterAndSortFiles(),this.renderFileList(),this.updateStatus(`\u5DF2\u52A0\u8F7D ${this.files.length} \u4E2A\u6587\u4EF6`)}catch(t){this.updateStatus(`\u52A0\u8F7D\u5931\u8D25: ${t.message}`,"error"),console.error("\u52A0\u8F7D\u6587\u4EF6\u5931\u8D25:",t)}finally{this.isLoading=!1}}filterAndSortFiles(){if(this.searchQuery.trim()){let t=this.searchQuery.toLowerCase();this.filteredFiles=this.files.filter(e=>e.name.toLowerCase().includes(t)||e.path.toLowerCase().includes(t))}else this.filteredFiles=[...this.files];this.filteredFiles.sort((t,e)=>{let i=0;switch(this.sortBy){case"name":i=t.name.localeCompare(e.name);break;case"size":i=t.size-e.size;break;case"modified":i=t.modified.getTime()-e.modified.getTime();break;case"created":i=t.created.getTime()-e.created.getTime();break}return this.sortOrder==="desc"?-i:i})}renderFileList(){if(this.contentEl.empty(),this.filteredFiles.length===0){this.searchQuery.trim()?this.contentEl.createEl("p",{text:`\u6CA1\u6709\u627E\u5230\u5305\u542B "${this.searchQuery}" \u7684\u6587\u4EF6`,cls:"no-results"}):this.contentEl.createEl("p",{text:"\u6CA1\u6709\u627E\u5230\u6587\u4EF6",cls:"no-results"});return}let t=this.contentEl.createEl("div",{cls:"file-list"});for(let e of this.filteredFiles){let i=t.createEl("div",{cls:"file-item"}),n=i.createEl("div",{cls:"file-header"});n.createEl("span",{text:"\u{1F4C4}",cls:"file-icon"}),n.createEl("span",{text:e.name,cls:"file-name"}).addEventListener("click",()=>{this.openFile(e)});let r=i.createEl("div",{cls:"file-info"});r.createEl("span",{text:e.path,cls:"file-path"}),r.createEl("span",{text:this.formatFileSize(e.size),cls:"file-size"}),r.createEl("span",{text:`${e.lines} \u884C`,cls:"file-lines"}),r.createEl("span",{text:this.formatDate(e.modified),cls:"file-modified"});let p=i.createEl("div",{cls:"file-actions"});p.createEl("button",{text:"\u9884\u89C8",cls:"preview-button"}).addEventListener("click",()=>{this.previewFile(e)}),p.createEl("button",{text:"\u4E0B\u8F7D",cls:"download-button"}).addEventListener("click",()=>{this.downloadFile(e)}),p.createEl("button",{text:"\u5220\u9664",cls:"delete-button"}).addEventListener("click",()=>{this.deleteFile(e)})}}async openFile(t){try{let e=await this.apiClient.getFile(t.name);await this.app.workspace.getLeaf(!0).openFile(await this.app.vault.create(`${t.name}`,e.content))}catch(e){new f.Notice(`\u6253\u5F00\u6587\u4EF6\u5931\u8D25: ${e.message}`),console.error("\u6253\u5F00\u6587\u4EF6\u5931\u8D25:",e)}}async previewFile(t){try{let e=await this.apiClient.getFile(t.name);new O(this.app,t.name,e.content).open()}catch(e){new f.Notice(`\u9884\u89C8\u6587\u4EF6\u5931\u8D25: ${e.message}`),console.error("\u9884\u89C8\u6587\u4EF6\u5931\u8D25:",e)}}async downloadFile(t){try{let e=await this.apiClient.getFile(t.name),i=new Blob([e.content],{type:"text/plain"}),n=URL.createObjectURL(i),a=document.createElement("a");a.href=n,a.download=t.name,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(n),new f.Notice(`\u5DF2\u4E0B\u8F7D: ${t.name}`)}catch(e){new f.Notice(`\u4E0B\u8F7D\u6587\u4EF6\u5931\u8D25: ${e.message}`),console.error("\u4E0B\u8F7D\u6587\u4EF6\u5931\u8D25:",e)}}async deleteFile(t){if(await confirm(`\u786E\u5B9A\u8981\u5220\u9664 "${t.name}" \u5417\uFF1F`))try{await this.apiClient.deleteFile(t.name),new f.Notice(`\u5DF2\u5220\u9664: ${t.name}`),await this.refreshFiles()}catch(i){new f.Notice(`\u5220\u9664\u6587\u4EF6\u5931\u8D25: ${i.message}`),console.error("\u5220\u9664\u6587\u4EF6\u5931\u8D25:",i)}}updateStatus(t,e="info"){this.statusEl.empty();let i=this.statusEl.createEl("span",{text:t,cls:`status-text status-${e}`});this.lastRefresh&&this.statusEl.createEl("span",{text:` | \u6700\u540E\u66F4\u65B0: ${this.formatDate(this.lastRefresh)}`,cls:"last-refresh"})}formatFileSize(t){if(t===0)return"0 B";let e=1024,i=["B","KB","MB","GB"],n=Math.floor(Math.log(t)/Math.log(e));return parseFloat((t/Math.pow(e,n)).toFixed(2))+" "+i[n]}formatDate(t){let i=new Date().getTime()-t.getTime(),n=Math.floor(i/(1e3*60*60*24));return n===0?t.toLocaleTimeString():n===1?"\u6628\u5929 "+t.toLocaleTimeString():n<7?`${n}\u5929\u524D`:t.toLocaleDateString()}static open(t,e){t.workspace.getLeaf(!0).setViewState({type:b,active:!0})}},O=class{constructor(s,t,e){this.modal=new class extends s.Modal{constructor(n,a,r){super(n);this.title=a;this.content=r}onOpen(){let{contentEl:n}=this;n.createEl("h2",{text:this.title});let r=n.createEl("div",{cls:"preview-area"}).createEl("textarea",{value:this.content,cls:"preview-textarea"});r.readOnly=!0,r.style.width="100%",r.style.height="400px",r.style.fontFamily="monospace"}onClose(){let{contentEl:n}=this;n.empty()}}(s,t,e)}open(){this.modal.open()}close(){this.modal.close()}};var y=require("obsidian");var C="openclaw-sync-status-view",v=class extends y.ItemView{constructor(t,e){super(t);this.isAutoRefresh=!0;this.refreshIntervalId=0;this.errorDetailsVisible=new Map;this.syncEngine=e,this.status=e.getStatus(),this.syncEngine.onStatusChange(i=>{this.status=i,this.render()})}getViewType(){return C}getDisplayText(){return"OpenClaw\u540C\u6B65\u72B6\u6001"}getIcon(){return"refresh-cw"}async onOpen(){let t=this.containerEl.children[1];t.empty();let e=t.createDiv({cls:"openclaw-sync-status-view"});e.createDiv({cls:"sync-status-header"}).createEl("h2",{text:"OpenClaw\u540C\u6B65\u72B6\u6001"});let n=e.createDiv({cls:"sync-controls"});n.createEl("button",{text:"\u7ACB\u5373\u540C\u6B65",cls:"sync-now-button"}).addEventListener("click",()=>{this.syncEngine.sync().catch(l=>{new y.Notice(`\u540C\u6B65\u5931\u8D25: ${l.message}`)})});let r=n.createEl("button",{text:this.syncEngine.isPausedState()?"\u6062\u590D\u540C\u6B65":"\u6682\u505C\u540C\u6B65",cls:"pause-resume-button"});r.addEventListener("click",()=>{this.syncEngine.isPausedState()?(this.syncEngine.resume(),r.setText("\u6682\u505C\u540C\u6B65"),new y.Notice("\u540C\u6B65\u5DF2\u6062\u590D")):(this.syncEngine.pause(),r.setText("\u6062\u590D\u540C\u6B65"),new y.Notice("\u540C\u6B65\u5DF2\u6682\u505C"))});let p=n.createDiv({cls:"auto-refresh-container"}),c=p.createEl("input",{type:"checkbox",cls:"auto-refresh-checkbox"});c.id="auto-refresh",c.checked=this.isAutoRefresh,c.addEventListener("change",l=>{this.isAutoRefresh=l.target.checked,this.isAutoRefresh?this.startAutoRefresh():this.stopAutoRefresh()}),p.createEl("label",{text:"\u81EA\u52A8\u5237\u65B0",attr:{for:"auto-refresh"}}),n.createEl("button",{text:"\u5237\u65B0",cls:"refresh-button"}).addEventListener("click",()=>{this.render()}),this.contentEl=e.createDiv({cls:"sync-status-content"}),this.isAutoRefresh&&this.startAutoRefresh(),this.render()}async onClose(){this.stopAutoRefresh()}render(){this.contentEl.empty();let t=this.contentEl.createDiv({cls:"status-card"}),e=t.createDiv({cls:"status-header"}),i=e.createEl("span",{text:this.getStatusIcon(),cls:"status-icon"}),n=e.createEl("span",{text:this.getStatusText(),cls:`status-text status-${this.status.state}`});if(this.status.state==="syncing"){let l=t.createDiv({cls:"progress-container"}),d=l.createEl("div",{cls:"progress-bar"}).createEl("div",{cls:"progress-fill",attr:{style:`width: ${this.status.progress}%`}}),m=l.createEl("div",{text:`${this.status.progress.toFixed(1)}%`,cls:"progress-text"})}if(this.status.currentFile){let l=t.createDiv({cls:"current-file"});l.createEl("strong",{text:"\u5F53\u524D\u6587\u4EF6: "}),l.createEl("span",{text:this.status.currentFile})}let a=t.createDiv({cls:"stats"});if(this.status.filesSynced>0&&a.createEl("div",{text:`\u5DF2\u540C\u6B65\u6587\u4EF6: ${this.status.filesSynced}`,cls:"stat-item"}),this.status.totalFiles>0&&a.createEl("div",{text:`\u603B\u6587\u4EF6\u6570: ${this.status.totalFiles}`,cls:"stat-item"}),this.status.lastSync&&a.createEl("div",{text:`\u6700\u540E\u540C\u6B65: ${this.formatDate(this.status.lastSync)}`,cls:"stat-item"}),this.status.errors.length>0){let l=this.contentEl.createDiv({cls:"errors-section"});l.createEl("h3",{text:"\u9519\u8BEF\u65E5\u5FD7"});let L=l.createEl("div",{cls:"errors-list"});this.status.errors.forEach((d,m)=>{let $=L.createEl("div",{cls:"error-item"}),F=$.createEl("div",{cls:"error-header"});if(F.createEl("span",{text:"\u274C",cls:"error-icon"}),F.createEl("span",{text:d.message,cls:"error-message"}),F.createEl("span",{text:this.formatDate(d.timestamp),cls:"error-time"}),F.createEl("button",{text:this.errorDetailsVisible.get(m)?"\u9690\u85CF\u8BE6\u60C5":"\u663E\u793A\u8BE6\u60C5",cls:"error-toggle-button"}).addEventListener("click",()=>{let w=this.errorDetailsVisible.get(m)||!1;this.errorDetailsVisible.set(m,!w),this.render()}),this.errorDetailsVisible.get(m)){let w=$.createEl("div",{cls:"error-details"});d.file&&w.createEl("div",{text:`\u6587\u4EF6: ${d.file}`,cls:"error-file"}),w.createEl("div",{text:`\u65F6\u95F4: ${d.timestamp.toLocaleString()}`,cls:"error-timestamp"}),w.createEl("div",{text:`\u53EF\u91CD\u8BD5: ${d.retryable?"\u662F":"\u5426"}`,cls:"error-retryable"}),d.retryable&&d.file&&w.createEl("button",{text:"\u91CD\u8BD5",cls:"retry-button"}).addEventListener("click",()=>{new y.Notice(`\u91CD\u8BD5\u6587\u4EF6: ${d.file}`)})}}),this.status.errors.length>0&&l.createEl("button",{text:"\u6E05\u9664\u6240\u6709\u9519\u8BEF",cls:"clear-errors-button"}).addEventListener("click",()=>{new y.Notice("\u9519\u8BEF\u65E5\u5FD7\u5DF2\u6E05\u9664")})}let r=this.contentEl.createDiv({cls:"history-section"});r.createEl("h3",{text:"\u540C\u6B65\u5386\u53F2"});let p=r.createEl("div",{text:"\u540C\u6B65\u5386\u53F2\u8BB0\u5F55\u5C06\u5728\u8FD9\u91CC\u663E\u793A",cls:"history-placeholder"}),c=this.contentEl.createDiv({cls:"performance-section"});c.createEl("h3",{text:"\u6027\u80FD\u7EDF\u8BA1"});let g=c.createDiv({cls:"performance-stats"});g.createEl("div",{text:"\u5E73\u5747\u540C\u6B65\u65F6\u95F4: --",cls:"performance-item"}),g.createEl("div",{text:"\u6700\u5FEB\u540C\u6B65\u65F6\u95F4: --",cls:"performance-item"}),g.createEl("div",{text:"\u6700\u6162\u540C\u6B65\u65F6\u95F4: --",cls:"performance-item"}),g.createEl("div",{text:"\u6210\u529F\u7387: --",cls:"performance-item"})}getStatusIcon(){switch(this.status.state){case"idle":return"\u2705";case"syncing":return"\u{1F504}";case"conflict":return"\u26A0\uFE0F";case"error":return"\u274C";case"paused":return"\u23F8\uFE0F";default:return"\u2753"}}getStatusText(){switch(this.status.state){case"idle":return"\u7A7A\u95F2";case"syncing":return"\u540C\u6B65\u4E2D";case"conflict":return"\u5B58\u5728\u51B2\u7A81";case"error":return"\u9519\u8BEF";case"paused":return"\u5DF2\u6682\u505C";default:return"\u672A\u77E5\u72B6\u6001"}}formatDate(t){let i=new Date().getTime()-t.getTime(),n=Math.floor(i/(1e3*60));return n<1?"\u521A\u521A":n<60?`${n}\u5206\u949F\u524D`:n<24*60?`${Math.floor(n/60)}\u5C0F\u65F6\u524D`:t.toLocaleDateString()}startAutoRefresh(){this.stopAutoRefresh(),this.refreshIntervalId=window.setInterval(()=>{this.render()},5e3)}stopAutoRefresh(){this.refreshIntervalId&&(clearInterval(this.refreshIntervalId),this.refreshIntervalId=0)}static open(t,e){t.workspace.getLeaf(!0).setViewState({type:C,active:!0})}};var E=class{constructor(s){this.settings=s;this.logs=[];this.maxLogs=1e3;this.listeners=[]}debug(s,t,e){this.log("debug",s,t,e)}info(s,t,e){this.log("info",s,t,e)}warn(s,t,e){this.log("warn",s,t,e)}error(s,t,e){this.log("error",s,t,e)}log(s,t,e,i){if(!this.shouldLog(s))return;let n={timestamp:new Date,level:s,message:t,source:e,data:i};this.logs.push(n),this.logs.length>this.maxLogs&&(this.logs=this.logs.slice(-this.maxLogs)),this.consoleLog(n),this.notifyListeners(n)}shouldLog(s){let t={["debug"]:0,["info"]:1,["warn"]:2,["error"]:3},e=t[this.settings.logLevel];return t[s]>=e}consoleLog(s){let e=`[${s.timestamp.toISOString().split("T")[1].split(".")[0]}] [${s.level.toUpperCase()}]`,i=s.source?`[${s.source}]`:"",n=`${e}${i} ${s.message}`;switch(s.level){case"debug":console.debug(n,s.data||"");break;case"info":console.info(n,s.data||"");break;case"warn":console.warn(n,s.data||"");break;case"error":console.error(n,s.data||"");break}}notifyListeners(s){this.listeners.forEach(t=>{try{t(s)}catch(e){console.error("\u65E5\u5FD7\u76D1\u542C\u5668\u9519\u8BEF:",e)}})}getLogs(s,t){let e=this.logs;return s&&(e=e.filter(i=>i.level===s)),t&&t>0&&(e=e.slice(-t)),[...e]}clearLogs(){this.logs=[]}onLog(s){this.listeners.push(s)}offLog(s){let t=this.listeners.indexOf(s);t>-1&&this.listeners.splice(t,1)}getStats(){let s={total:this.logs.length,byLevel:{["debug"]:0,["info"]:0,["warn"]:0,["error"]:0},bySource:{},oldest:this.logs.length>0?this.logs[0].timestamp:null,newest:this.logs.length>0?this.logs[this.logs.length-1].timestamp:null};for(let t of this.logs)s.byLevel[t.level]++,t.source&&(s.bySource[t.source]=(s.bySource[t.source]||0)+1);return s}exportLogs(s="json"){return s==="json"?JSON.stringify(this.logs,null,2):this.logs.map(t=>{let e=t.timestamp.toISOString(),i=t.level.toUpperCase().padEnd(5),n=t.source?` [${t.source}]`:"";return`${e} ${i}${n} ${t.message}`}).join(`
`)}static formatError(s){if(s instanceof Error)return`${s.name}: ${s.message}
${s.stack||""}`;if(typeof s=="string")return s;try{return JSON.stringify(s)}catch(t){return String(s)}}static createContextLogger(s,t){let e=new E(t);return{debug:(i,n)=>e.debug(i,s,n),info:(i,n)=>e.info(i,s,n),warn:(i,n)=>e.warn(i,s,n),error:(i,n)=>e.error(i,s,n),getLogs:(i,n)=>e.getLogs(i,n),clearLogs:()=>e.clearLogs(),onLog:i=>e.onLog(i),offLog:i=>e.offLog(i),getStats:()=>e.getStats(),exportLogs:i=>e.exportLogs(i)}}};var B={apiUrl:"localhost",apiPort:8765,syncInterval:300,autoSync:!0,conflictStrategy:"timestamp",excludePatterns:["*.tmp",".*"],enableWebSocket:!0,logLevel:"info",targetFolder:"OpenClaw\u8BB0\u5FC6\u5E93"},D=class extends o.Plugin{async onload(){await this.loadSettings(),this.logger=new E(this.settings),this.logger.info("OpenClaw Memory Sync\u63D2\u4EF6\u5F00\u59CB\u52A0\u8F7D","plugin"),this.apiClient=new x(this.settings),this.syncEngine=new P(this.app,this.apiClient,this.settings),this.registerView(b,e=>new S(e,this.apiClient)),this.registerView(C,e=>new v(e,this.syncEngine)),this.registerView(b,e=>new S(e,this.apiClient)),this.registerView(C,e=>new v(e,this.syncEngine)),this.addSettingTab(new k(this.app,this)),this.addCommand({id:"openclaw-sync-now",name:"\u7ACB\u5373\u540C\u6B65",callback:()=>this.syncNow()}),this.addCommand({id:"openclaw-view-memory",name:"\u67E5\u770B\u8BB0\u5FC6\u5E93",callback:()=>S.open(this.app,this.apiClient)}),this.addCommand({id:"openclaw-view-status",name:"\u67E5\u770B\u540C\u6B65\u72B6\u6001",callback:()=>v.open(this.app,this.syncEngine)}),this.addRibbonIcon("brain","OpenClaw\u8BB0\u5FC6\u540C\u6B65",()=>{v.open(this.app,this.syncEngine)});let t=this.addStatusBarItem();t.setText("\u{1F504} OpenClaw"),this.syncEngine.onStatusChange(e=>{let i={idle:"\u2705",syncing:"\u{1F504}",conflict:"\u26A0\uFE0F",error:"\u274C",paused:"\u23F8\uFE0F"};t.setText(`${i[e.state]} OpenClaw`),e.state==="error"&&e.errors.length>0?t.setAttr("title",`\u540C\u6B65\u9519\u8BEF: ${e.errors[0].message}`):t.setAttr("title",`\u540C\u6B65\u72B6\u6001: ${e.state}`)});try{this.logger.info("\u6B63\u5728\u8FDE\u63A5OpenClaw API\u670D\u52A1\u5668...","api"),await this.apiClient.connect(),new o.Notice("\u2705 OpenClaw API\u8FDE\u63A5\u6210\u529F"),this.logger.info("OpenClaw API\u8FDE\u63A5\u6210\u529F","api")}catch(e){let i=`OpenClaw API\u8FDE\u63A5\u5931\u8D25: ${e.message}`;new o.Notice(`\u274C ${i}`),this.logger.error(i,"api",e)}this.settings.autoSync&&(this.startAutoSync(),this.logger.info(`\u81EA\u52A8\u540C\u6B65\u5DF2\u542F\u52A8\uFF0C\u95F4\u9694: ${this.settings.syncInterval}\u79D2`,"sync")),await this.ensureTargetFolder(),this.logger.info("OpenClaw Memory Sync\u63D2\u4EF6\u52A0\u8F7D\u5B8C\u6210","plugin")}async onunload(){this.logger.info("OpenClaw Memory Sync\u63D2\u4EF6\u5F00\u59CB\u5378\u8F7D","plugin"),this.stopAutoSync(),await this.apiClient.disconnect(),this.syncEngine.cleanup(),this.logger.info("OpenClaw Memory Sync\u63D2\u4EF6\u5378\u8F7D\u5B8C\u6210","plugin")}async loadSettings(){this.settings=Object.assign({},B,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}async syncNow(){try{this.logger.info("\u5F00\u59CB\u624B\u52A8\u540C\u6B65OpenClaw\u8BB0\u5FC6\u5E93","sync"),new o.Notice("\u{1F504} \u5F00\u59CB\u540C\u6B65OpenClaw\u8BB0\u5FC6\u5E93..."),await this.syncEngine.sync(),this.logger.info("OpenClaw\u8BB0\u5FC6\u5E93\u540C\u6B65\u5B8C\u6210","sync"),new o.Notice("\u2705 OpenClaw\u8BB0\u5FC6\u5E93\u540C\u6B65\u5B8C\u6210")}catch(t){let e=`\u540C\u6B65\u5931\u8D25: ${t.message}`;this.logger.error(e,"sync",t),new o.Notice(`\u274C ${e}`)}}startAutoSync(){this.syncIntervalId&&clearInterval(this.syncIntervalId),this.syncIntervalId=window.setInterval(()=>{this.syncEngine.getStatus().state==="idle"&&(this.logger.debug("\u81EA\u52A8\u540C\u6B65\u89E6\u53D1","sync"),this.syncNow())},this.settings.syncInterval*1e3),this.logger.info(`\u81EA\u52A8\u540C\u6B65\u5DF2\u542F\u52A8\uFF0C\u95F4\u9694: ${this.settings.syncInterval}\u79D2`,"sync")}stopAutoSync(){this.syncIntervalId&&(clearInterval(this.syncIntervalId),this.syncIntervalId=0,this.logger.info("\u81EA\u52A8\u540C\u6B65\u5DF2\u505C\u6B62","sync"))}async ensureTargetFolder(){let{vault:t}=this.app,e=this.settings.targetFolder,i=t.getAbstractFileByPath(e);i?i instanceof o.TFolder?this.logger.debug(`\u76EE\u6807\u6587\u4EF6\u5939\u5DF2\u5B58\u5728: ${e}`,"filesystem"):this.logger.warn(`\u8DEF\u5F84 ${e} \u5DF2\u5B58\u5728\u4F46\u4E0D\u662F\u6587\u4EF6\u5939`,"filesystem"):(await t.createFolder(e),this.logger.info(`\u521B\u5EFA\u76EE\u6807\u6587\u4EF6\u5939: ${e}`,"filesystem"))}},k=class extends o.PluginSettingTab{constructor(t,e){super(t,e);this.plugin=e}display(){let{containerEl:t}=this;t.empty(),t.createEl("h2",{text:"OpenClaw\u8BB0\u5FC6\u540C\u6B65\u8BBE\u7F6E"}),new o.Setting(t).setName("API\u670D\u52A1\u5668\u5730\u5740").setDesc("OpenClaw API\u670D\u52A1\u5668\u7684\u5730\u5740").addText(e=>e.setPlaceholder("localhost").setValue(this.plugin.settings.apiUrl).onChange(async i=>{this.plugin.settings.apiUrl=i,await this.plugin.saveSettings()})),new o.Setting(t).setName("API\u7AEF\u53E3").setDesc("OpenClaw API\u670D\u52A1\u5668\u7684\u7AEF\u53E3").addText(e=>e.setPlaceholder("8765").setValue(this.plugin.settings.apiPort.toString()).onChange(async i=>{this.plugin.settings.apiPort=parseInt(i)||8765,await this.plugin.saveSettings()})),new o.Setting(t).setName("\u81EA\u52A8\u540C\u6B65").setDesc("\u542F\u7528\u81EA\u52A8\u540C\u6B65").addToggle(e=>e.setValue(this.plugin.settings.autoSync).onChange(async i=>{this.plugin.settings.autoSync=i,await this.plugin.saveSettings(),i?this.plugin.startAutoSync():this.plugin.stopAutoSync()})),new o.Setting(t).setName("\u540C\u6B65\u95F4\u9694\uFF08\u79D2\uFF09").setDesc("\u81EA\u52A8\u540C\u6B65\u7684\u65F6\u95F4\u95F4\u9694").addText(e=>e.setPlaceholder("300").setValue(this.plugin.settings.syncInterval.toString()).onChange(async i=>{this.plugin.settings.syncInterval=parseInt(i)||300,await this.plugin.saveSettings(),this.plugin.settings.autoSync&&(this.plugin.stopAutoSync(),this.plugin.startAutoSync())})),new o.Setting(t).setName("\u51B2\u7A81\u89E3\u51B3\u7B56\u7565").setDesc("\u5F53\u6587\u4EF6\u51B2\u7A81\u65F6\u7684\u89E3\u51B3\u7B56\u7565").addDropdown(e=>e.addOption("timestamp","\u65F6\u95F4\u6233\u4F18\u5148\uFF08\u6700\u65B0\u7684\u80DC\u51FA\uFF09").addOption("local","\u672C\u5730\u4F18\u5148").addOption("remote","\u8FDC\u7A0B\u4F18\u5148").addOption("ask","\u8BE2\u95EE\u7528\u6237").setValue(this.plugin.settings.conflictStrategy).onChange(async i=>{this.plugin.settings.conflictStrategy=i,await this.plugin.saveSettings()})),new o.Setting(t).setName("\u76EE\u6807\u6587\u4EF6\u5939").setDesc("\u8BB0\u5FC6\u6587\u4EF6\u4FDD\u5B58\u7684\u6587\u4EF6\u5939\u8DEF\u5F84").addText(e=>e.setPlaceholder("OpenClaw\u8BB0\u5FC6\u5E93").setValue(this.plugin.settings.targetFolder).onChange(async i=>{this.plugin.settings.targetFolder=i,await this.plugin.saveSettings(),await this.plugin.ensureTargetFolder()})),new o.Setting(t).setName("\u542F\u7528WebSocket").setDesc("\u542F\u7528\u5B9E\u65F6\u66F4\u65B0\u901A\u77E5").addToggle(e=>e.setValue(this.plugin.settings.enableWebSocket).onChange(async i=>{this.plugin.settings.enableWebSocket=i,await this.plugin.saveSettings()})),new o.Setting(t).setName("\u6392\u9664\u6A21\u5F0F").setDesc("\u4E0D\u540C\u6B65\u7684\u6587\u4EF6\u6A21\u5F0F\uFF08\u6BCF\u884C\u4E00\u4E2A\uFF09").addTextArea(e=>e.setPlaceholder(`*.tmp
.*
node_modules/`).setValue(this.plugin.settings.excludePatterns.join(`
`)).onChange(async i=>{this.plugin.settings.excludePatterns=i.split(`
`).filter(n=>n.trim()),await this.plugin.saveSettings()})),new o.Setting(t).setName("\u65E5\u5FD7\u7EA7\u522B").setDesc("\u63A7\u5236\u53F0\u65E5\u5FD7\u7684\u8BE6\u7EC6\u7A0B\u5EA6").addDropdown(e=>e.addOption("debug","\u8C03\u8BD5").addOption("info","\u4FE1\u606F").addOption("warn","\u8B66\u544A").addOption("error","\u9519\u8BEF").setValue(this.plugin.settings.logLevel).onChange(async i=>{this.plugin.settings.logLevel=i,await this.plugin.saveSettings()})),new o.Setting(t).setName("\u6D4B\u8BD5\u8FDE\u63A5").setDesc("\u6D4B\u8BD5\u4E0EOpenClaw API\u670D\u52A1\u5668\u7684\u8FDE\u63A5").addButton(e=>e.setButtonText("\u6D4B\u8BD5\u8FDE\u63A5").onClick(async()=>{try{await this.plugin.apiClient.testConnection(),new o.Notice("\u2705 \u8FDE\u63A5\u6D4B\u8BD5\u6210\u529F")}catch(i){new o.Notice(`\u274C \u8FDE\u63A5\u6D4B\u8BD5\u5931\u8D25: ${i.message}`)}})),new o.Setting(t).setName("\u7ACB\u5373\u540C\u6B65").setDesc("\u624B\u52A8\u89E6\u53D1\u540C\u6B65").addButton(e=>e.setButtonText("\u5F00\u59CB\u540C\u6B65").onClick(async()=>{await this.plugin.syncNow()}))}};
